---
- name: Upload a file to GIT
  hosts: localhost
  gather_facts: False
  vars:
    dest_dir: /tmp/git
    email: bla@bla.com
    repo: https://github.com/shaunhofer/ansible.git
    
  tasks:   
    - name: Clone Git repository
      git:
        repo: "{{ repo }}"
        dest: "{{ dest_dir }}"
      become: true
      
    - name: Set Git details
      git_config:
        name: user.name
        scope: global
        repo: "{{ dest_dir }}"
        value: "shaunhofer"
        
    - name: Set Git details
      command: git config --global user.name "shaunhofer"
      become: true
      
    - name: Set Git details
      command: git config --global user.email "{{ email }}"
      become: true
      
    - name: Copy file to Git repository
      copy:
        src: /etc/hostname
        dest: "{{ dest_dir }}/F5/backup"
      become: true
    
    - name: Add to Git repository
      command: git add {{ item }}
      with_items:
        - "{{ dest_dir }}/F5/backup"
      args:
        chdir: "{{ dest_dir }}/F5/backup"
      become: true
    
    - name: commit INTIAL to Git repository
      command: git commit -m "initial commit"
      args:
        chdir: "{{ dest_dir }}/F5/backup"
      become: true
    
    #- name: commit file to Git repository
    #  command: git commit -m "Adding {{ item }}"
    #  with_items:
    #    - "{{ dest_dir }}/F5/backup"
    #  args:
    #    chdir: "{{ dest_dir }}/F5/backup"
    #  become: true

    - name: Set remote repo
      command: git remote set-url origin git@github.com:shaunhofer/ansible.git
      args:
        chdir: "{{ dest_dir }}"
      become: true

    - name: Check GIT remote
      command: git remote -v 
      args:
        chdir: "{{ dest_dir }}"
      become: true
      
    - name: Scan for SSH keys
      ansible.builtin.shell:
        cmd: "ssh-keyscan github.com
              2>/dev/null"
      register: ssh_scan

    - name: Set stdout_lines array for ssh_scan
      set_fact:
        ssout: []
  
    - name: Fill ssout
      set_fact:
        ssout: "{{ ssout + ss_r.stdout_lines }}"
      loop: "{{ ssh_scan.results }}"
      loop_control:
        loop_var:
          ss_r
      when: ss_r.stdout_lines is defined

    - name: Add client ssh keys to known_hosts
      ansible.builtin.known_hosts:
        name: github.com
        key: "{{ ssh_scan }}"
        state: present
        path: /etc/ssh/ssh_known_hosts
      
    #- name: Update known hosts for ssh #https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/githubs-ssh-key-fingerprints
    #  ansible.builtin.known_hosts:
     #   name: guthub.com
     #   key: "{{ lookup('ansible.builtin.pipe', 'ssh-keyscan guthub.com') }}"
     #   path: /etc/ssh/ssh_known_hosts
     #   state: present

    - name: Cat known_hosts
      command: cat /etc/ssh/ssh_known_hosts
      become: true

    - name: Push changes to Git repository
      command: git push origin main
      args:
        chdir: "{{ dest_dir }}"
      become: true
